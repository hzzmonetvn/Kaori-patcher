name: Build Android Framework Mod

on:
  workflow_dispatch:
    inputs:
      # --- SECTION 1: LINKS ---
      link_framework:
        description: 'Link framework.jar (B·∫Øt bu·ªôc)'
        required: true
        type: string
      link_services:
        description: 'Link services.jar (T√πy ch·ªçn)'
        required: false
        type: string
      link_miui_framework:
        description: 'Link miui-framework.jar (T√πy ch·ªçn)'
        required: false
        type: string
      link_miui_services:
        description: 'Link miui-services.jar (T√πy ch·ªçn)'
        required: false
        type: string

      # --- SECTION 2: OPTIONS ---
      opt_fix_bootloop:
        description: 'Fix Bootloop (A15)'
        required: true
        default: true
        type: boolean
      opt_patch_apk:
        description: 'Patch APK Protection'
        required: true
        default: true
        type: boolean
      opt_patch_kaori:
        description: 'Patch Kaori Features'
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # --- B∆Ø·ªöC T·∫¢I FILE ---
      - name: Download JAR Files
        run: |
          # H√†m t·∫£i file an to√†n
          download_file() {
            url="$1"
            name="$2"
            if [ -n "$url" ]; then
              echo "‚¨áÔ∏è ƒêang t·∫£i $name..."
              wget -O "$name" "$url"
            else
              echo "‚ÑπÔ∏è B·ªè qua $name (Kh√¥ng c√≥ link)"
            fi
          }

          download_file "${{ inputs.link_framework }}" "framework.jar"
          download_file "${{ inputs.link_services }}" "services.jar"
          download_file "${{ inputs.link_miui_framework }}" "miui-framework.jar"
          download_file "${{ inputs.link_miui_services }}" "miui-services.jar"

          # Ki·ªÉm tra file b·∫Øt bu·ªôc
          if [ ! -f "framework.jar" ]; then
            echo "‚ùå L·ªói: Thi·∫øu framework.jar!"
            exit 1
          fi

      # --- B∆Ø·ªöC CH·∫†Y PYTHON ---
      - name: 1. Unpack Jars
        run: python unpack.py

      - name: 2. Fix Bootloop
        env:
          ENABLE_MOD: ${{ inputs.opt_fix_bootloop }}
        run: python bootloop.py

      - name: 3. Apk Protection
        env:
          ENABLE_MOD: ${{ inputs.opt_patch_apk }}
        run: python apk.py

      - name: 4. Kaori Features
        env:
          ENABLE_MOD: ${{ inputs.opt_patch_kaori }}
        run: python kaori.py

      - name: 5. Repack and Create Module
        run: python repack.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Magisk-Module-Framework
          path: Module-framework-test.zip
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. C√†i ƒë·∫∑t m√¥i tr∆∞·ªùng
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set up Java (Cho Smali)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. T·∫£i Tools c·∫ßn thi·∫øt (Smali/Baksmali)
      - name: Download Smali Tools
        run: |
          wget -O smali.jar https://bitbucket.org/JesusFreke/smali/downloads/smali-2.5.2.jar
          wget -O baksmali.jar https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.5.2.jar

      # 4. T·∫£i c√°c file JAR t·ª´ Link ng∆∞·ªùi d√πng nh·∫≠p
      - name: Download Target JARs
        run: |
          echo "Downloading framework.jar..."
          wget -O framework.jar "${{ inputs.framework_url }}"
          
          if [ -n "${{ inputs.services_url }}" ]; then
            echo "Downloading services.jar..."
            wget -O services.jar "${{ inputs.services_url }}"
          fi
          
          if [ -n "${{ inputs.miui_framework_url }}" ]; then
            echo "Downloading miui-framework.jar..."
            wget -O miui-framework.jar "${{ inputs.miui_framework_url }}"
          fi
          
          if [ -n "${{ inputs.miui_services_url }}" ]; then
            echo "Downloading miui-services.jar..."
            wget -O miui-services.jar "${{ inputs.miui_services_url }}"
          fi

      # 5. QUAN TR·ªåNG: S·ª≠a file usagi.py ƒë·ªÉ ch·∫°y t·ª± ƒë·ªông
      # V√¨ code g·ªëc c√≥ l·ªánh input() b·∫Øt ch·ªù nh·∫•n Enter, ta ph·∫£i x√≥a n√≥ ƒëi
      - name: Patch usagi.py for Automation
        run: |
          # Thay th·∫ø l·ªánh input(...) th√†nh l·ªánh pass (b·ªè qua)
          sed -i 's/input("Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c...")/pass/g' usagi.py
          # X√≥a ho·∫∑c v√¥ hi·ªáu h√≥a CLI loop n·∫øu c·∫ßn (nh∆∞ng ta s·∫Ω import class n√™n ko lo)

      # 6. Ch·∫°y Script Logic
      - name: Run Usagi Logic
        env:
          DO_FIX_BOOTLOOP: ${{ inputs.fix_bootloop }}
          DO_APK_PROTECTION: ${{ inputs.apk_protection }}
          DO_KAORI_TOOLBOX: ${{ inputs.kaori_toolbox }}
        run: |
          # T·∫°o file python runner t·∫°m th·ªùi ƒë·ªÉ ƒëi·ªÅu khi·ªÉn class KaoriosToolkit
          cat <<EOF > runner.py
          import os
          import sys
          # Import class t·ª´ file usagi.py c·ªßa b·∫°n
          from usagi import KaoriosToolkit

          def main():
              print(">>> [BOT] Kh·ªüi ƒë·ªông Usagi Toolkit...")
              toolkit = KaoriosToolkit()

              # 1. Ki·ªÉm tra file v√† Gi·∫£i n√©n
              files = toolkit.check_target_files()
              toolkit.unpack_all(files)

              # 2. Fix Bootloop
              if os.environ.get('DO_FIX_BOOTLOOP') == 'true':
                  print(">>> [BOT] Running Fix Bootloop...")
                  toolkit.fix_bootloop_a15()
              else:
                  print(">>> [BOT] Skipping Fix Bootloop")

              # 3. Apk Protection
              if os.environ.get('DO_APK_PROTECTION') == 'true':
                  print(">>> [BOT] Running Apk Protection...")
                  toolkit.apk_protection()
              else:
                  print(">>> [BOT] Skipping Apk Protection")

              # 4. Kaori Toolbox
              if os.environ.get('DO_KAORI_TOOLBOX') == 'true':
                  print(">>> [BOT] Running Kaori Toolbox...")
                  toolkit.kaori_toolbox()
              else:
                  print(">>> [BOT] Skipping Kaori Toolbox")

              # 5. Repack Classes
              print(">>> [BOT] Repacking Classes...")
              toolkit.repack_all_classes()

              # 6. Repack JAR Files
              print(">>> [BOT] Repacking JARs...")
              toolkit.repack_all_jar_files()

              # 7. Create Module
              # ƒê·∫£m b·∫£o th∆∞ m·ª•c t·ªìn t·∫°i ƒë·ªÉ tr√°nh l·ªói copy
              os.makedirs("module/system/framework", exist_ok=True)
              os.makedirs("module/system/system_ext/framework", exist_ok=True)
              
              print(">>> [BOT] Creating Module...")
              toolkit.create_test_module()
              
              print(">>> [BOT] Ho√†n t·∫•t!")

          if __name__ == "__main__":
              main()
          EOF
          
          # Ch·∫°y runner
          python3 runner.py

      # 7. G·ª≠i file qua Telegram
      - name: Send to Telegram
        if: success()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          ZIP_FILE="Module-framework-test.zip"
          
          if [ -f "$ZIP_FILE" ]; then
            echo "Sending $ZIP_FILE to Telegram..."
            curl -v -F "chat_id=$CHAT_ID" \
            -F document=@"$ZIP_FILE" \
            -F caption="üê∞ **Usagi Patcher Result**%0A‚úÖ Build Success!%0AüìÇ Framework: ${{ inputs.framework_url }}" \
            https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument
          else
            echo "‚ùå Kh√¥ng t√¨m th·∫•y file zip module!"
            curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="‚ùå Usagi Bot: Build ch·∫°y xong nh∆∞ng kh√¥ng th·∫•y file ZIP output."
          fi
          
